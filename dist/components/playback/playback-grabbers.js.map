{"version":3,"file":"playback-grabbers.js","sourceRoot":"","sources":["../../../src/components/playback/playback-grabbers.ts"],"names":[],"mappings":"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","sourcesContent":["import { LitElement, html } from 'lit';\nimport { customElement, property } from 'lit/decorators.js';\nimport { CurrentlyGrabbed, RangeTimings } from '../../types';\nimport VideoLoadedEvent from '../../events/video-loaded';\nimport AddGrabbersEvent from '../../events/add-grabbers';\nimport UpdateCurrentlyGrabbedEvent from '../../events/update-currently-grabbed';\nimport UpdateTimingsEvent from '../../events/update-timings';\nimport UpdateProgressEvent from '../../events/update-progress';\nimport VideoSeekEvent from '../../events/video-seek';\nimport VideoPauseEvent from '../../events/video-pause';\nimport SeekableResizedEvent from '../../events/seekable-resized';\nimport UpdateSeekableStyleEvent from '../../events/update-seekable-style';\n\n@customElement('playback-grabbers')\nexport class PlaybackGrabbers extends LitElement {\n\n  @property({ type: Array })\n  timings: Array<RangeTimings> = [];\n\n  @property({ type: Object })\n  currentlyGrabbed?: CurrentlyGrabbed = { index: 0, type: 'none' };\n\n  private videoDuration = 0;\n\n  private shouldShowGrabbers = false;\n\n  private seekableRect?: DOMRect;\n\n  constructor() {\n    super();\n\n    this.addEventListener(VideoLoadedEvent.eventName, ((e: VideoLoadedEvent) => {\n      this.videoDuration = e.detail.duration;\n    }) as EventListener);\n\n    this.addEventListener(AddGrabbersEvent.eventName, (() => {\n      this.shouldShowGrabbers = true;\n    }) as EventListener);\n\n    this.addEventListener(SeekableResizedEvent.eventName, ((e: SeekableResizedEvent) => {\n      this.seekableRect = e.detail.rect\n    }) as EventListener);\n  }\n\n  override render() {\n    return html`\n      <div id=\"grabbers\">\n        ${(this.shouldShowGrabbers && this.timings.length > 0) && this.timings.map((timing, i) => html`\n          <div id='grabberStart${i}' class='grabber' style=\"left: ${timing.start / this.videoDuration * 100}%\"\n            onMouseDown=\"handleGrabberMouseDown(event, ${i}, 'start')\"\n            onPointerDown=\"handleGrabberPointerDown(event, ${i}, 'start')\"\n          >\n            <svg version='1.1' xmlns='http://www.w3.org/2000/svg' x='0' y='0' width='10' height='14' viewBox='0 0 10 14' xmlSpace='preserve'>\n              <path class='st0' d='M1 14L1 14c-0.6 0-1-0.4-1-1V1c0-0.6 0.4-1 1-1h0c0.6 0 1 0.4 1 1v12C2 13.6 1.6 14 1 14zM5 14L5 14c-0.6 0-1-0.4-1-1V1c0-0.6 0.4-1 1-1h0c0.6 0 1 0.4 1 1v12C6 13.6 5.6 14 5 14zM9 14L9 14c-0.6 0-1-0.4-1-1V1c0-0.6 0.4-1 1-1h0c0.6 0 1 0.4 1 1v12C10 13.6 9.6 14 9 14z'/>\n            </svg>\n          </div>\n          <div id='grabberEnd${i}' class='grabber' style=\"left: ${timing.end / this.videoDuration * 100}%\"\n            onMouseDown=\"${this.handleGrabberMouseDown(i, 'end')}\"\n            onPointerDown=\"${this.handleGrabberPointerDown(i, 'end')}\"\n          >\n            <svg version='1.1' xmlns='http://www.w3.org/2000/svg' x='0' y='0' width='10' height='14' viewBox='0 0 10 14' xmlSpace='preserve'>\n              <path class='st0' d='M1 14L1 14c-0.6 0-1-0.4-1-1V1c0-0.6 0.4-1 1-1h0c0.6 0 1 0.4 1 1v12C2 13.6 1.6 14 1 14zM5 14L5 14c-0.6 0-1-0.4-1-1V1c0-0.6 0.4-1 1-1h0c0.6 0 1 0.4 1 1v12C6 13.6 5.6 14 5 14zM9 14L9 14c-0.6 0-1-0.4-1-1V1c0-0.6 0.4-1 1-1h0c0.6 0 1 0.4 1 1v12C10 13.6 9.6 14 9 14z'/>\n            </svg>\n          </div>\n        `)}\n      </div>\n    `;\n  }\n\n  private addActiveSegments() {\n    let colors = ''\n    let counter = 0;\n    \n    colors += `, rgba(240, 240, 240, 0) 0%, rgba(240, 240, 240, 0) ${this.timings[0].start / this.videoDuration * 100}%`\n    for (let times of this.timings) {\n      if (counter > 0) {\n        colors += `, rgba(240, 240, 240, 0) ${this.timings[counter].end / this.videoDuration * 100}%, rgba(240, 240, 240, 0) ${times.start / this.videoDuration * 100}%`\n      }\n      colors += `, #655dc2 ${times.start / this.videoDuration * 100}%, #655dc2 ${times.end / this.videoDuration * 100}%`\n      counter += 1\n    }\n    colors += `, rgba(240, 240, 240, 0) ${this.timings[counter - 1].end / this.videoDuration * 100}%, rgba(240, 240, 240, 0) 100%`\n    \n    this.dispatchEvent(new UpdateSeekableStyleEvent({ bubbles: true, composed: true, detail: { style: { backgroundImage: `linear-gradient(to right${colors})` }}}));\n  }\n\n  private handleMouseMoveWhenGrabbed(event: MouseEvent) {\n    const difference = 0.2;\n    \n    this.dispatchEvent(new VideoPauseEvent({ bubbles: true, composed: true }));\n\n    this.addActiveSegments();\n\n    let seekRatio = (event.clientX - this.seekableRect!.left) / this.seekableRect!.width;\n    const index = this.currentlyGrabbed!.index\n    const type = this.currentlyGrabbed!.type\n    let time = this.timings;\n    let seek = this.videoDuration * seekRatio\n  \n    if ((type === 'start') && (seek > ((index !== 0) ? (time[index - 1].end + difference + 0.2) : 0)) && seek < time[index].end - difference) {\n      this.dispatchEvent(new VideoSeekEvent({ bubbles: true, composed: true, detail: { seekTime: seek } }));\n\n      time[index]['start'] = seek;\n      this.dispatchEvent(new UpdateTimingsEvent({ bubbles: true, composed: true, detail: { timings: time } }))\n      \n      const grabberStart = this.shadowRoot?.getElementById(`grabberStart${index}`);\n      if (grabberStart) {\n        grabberStart.style.left = `${seekRatio * 100}%`;\n      }\n    } else if ((type === 'end')  && (seek > time[index].start + difference) && (seek < (index !== (this.timings.length - 1) ? time[index].start - difference - 0.2 : this.videoDuration))) {\n      time[index]['end'] = seek;\n      this.dispatchEvent(new UpdateTimingsEvent({ bubbles: true, composed: true, detail: { timings: time } }));\n      \n      const grabberEnd = this.shadowRoot?.getElementById(`grabberEnd${index}`);\n      if (grabberEnd) {\n        grabberEnd.style.left = `${seekRatio * 100}%`;\n      }\n    }\n    \n    const progressLeft = `${seekRatio * 100}%`;\n    const progressWidth = '0%';\n    this.dispatchEvent(new UpdateProgressEvent({ bubbles: true, composed: true, detail: { left: progressLeft, width: progressWidth }}));\n  }\n\n  private removePointerMoveEventListener() {\n    window.removeEventListener('pointermove', this.handleMouseMoveWhenGrabbed)\n  }\n  \n  private removeMouseMoveEventListener() {\n    window.removeEventListener('mousemove', this.handleMouseMoveWhenGrabbed)\n  }\n\n  private handleGrabberMouseDown(index: number, type: string) {\n    return () => {\n      this.dispatchEvent(new UpdateCurrentlyGrabbedEvent({ bubbles: true, composed: true, detail: { index, type }}));\n      window.addEventListener('mousemove', this.handleMouseMoveWhenGrabbed);\n      window.addEventListener('mouseup', this.removeMouseMoveEventListener);\n    }\n  }\n\n  private handleGrabberPointerDown(index: number, type: string) {\n    return () => {\n      this.dispatchEvent(new UpdateCurrentlyGrabbedEvent({ bubbles: true, composed: true, detail: { index, type }}));\n      window.addEventListener('pointermove', this.handleMouseMoveWhenGrabbed)\n      window.addEventListener('pointerup', this.removePointerMoveEventListener)\n    }\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'playback-grabbers': PlaybackGrabbers;\n  }\n}\n"]}