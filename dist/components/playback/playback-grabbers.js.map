{"version":3,"file":"playback-grabbers.js","sourceRoot":"","sources":["../../../src/components/playback/playback-grabbers.ts"],"names":[],"mappings":"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","sourcesContent":["import { LitElement, html } from 'lit';\nimport { customElement, state } from 'lit/decorators.js';\nimport { CurrentlyGrabbed, RangeTimings } from '../../types';\n// Events\nimport UpdateCurrentlyGrabbedEvent from '../../events/update-currently-grabbed';\nimport UpdateTimingsEvent from '../../events/update-timings';\nimport UpdateProgressEvent from '../../events/update-progress';\nimport VideoSeekEvent from '../../events/video-seek';\nimport VideoPauseEvent from '../../events/video-pause';\nimport UpdateSeekableStyleEvent from '../../events/update-seekable-style';\nimport { playbackGrabbersStyle } from '../../styles/playback-grabbers';\nimport '../../icons/icon-grabber';\n\n@customElement('playback-grabbers')\nexport class PlaybackGrabbers extends LitElement {\n  static override styles = playbackGrabbersStyle;\n\n  @state()\n  timings: Array<RangeTimings> = [];\n\n  @state()\n  currentlyGrabbed?: CurrentlyGrabbed = { index: 0, type: 'none' };\n\n  @state()\n  videoDuration = 0;\n\n  @state()\n  shouldShowGrabbers = false;\n\n  @state()\n  seekableRect?: DOMRect;\n\n  override render() {\n    return html`\n      <div id=\"grabbers\">\n        ${(this.shouldShowGrabbers && this.timings.length > 0) && this.timings.map((timing, i) => html`\n          <div id='grabberStart${i}' class='grabber' style=\"left: ${timing.start / this.videoDuration * 100}%\"\n            @mousedown=\"${this.handleGrabberMouseDown(i, 'start')}\"\n            @pointerdown=\"${this.handleGrabberPointerDown(i, 'start')}\"\n          >\n            <icon-grabber></icon-grabber>\n          </div>\n          <div id='grabberEnd${i}' class='grabber' style=\"left: ${timing.end / this.videoDuration * 100}%\"\n            @mousedown=\"${this.handleGrabberMouseDown(i, 'end')}\"\n            @pointerdown=\"${this.handleGrabberPointerDown(i, 'end')}\"\n          >\n            <icon-grabber></icon-grabber>\n          </div>\n        `)}\n      </div>\n    `;\n  }\n\n  private handleMouseMoveWhenGrabbed = (event: MouseEvent) => {\n    const difference = 0.2;\n\n    const addActiveSegments = () => {\n      let colors = ''\n      let counter = 0;\n\n      console.log('addActiveSegments', this.timings);\n\n      if (this.timings.length > 0) {\n        colors += `, rgba(240, 240, 240, 0) 0%, rgba(240, 240, 240, 0) ${this.timings?.[0].start / this.videoDuration * 100}%`\n        for (let times of this.timings) {\n          if (counter > 0) {\n            colors += `, rgba(240, 240, 240, 0) ${this.timings[counter].end / this.videoDuration * 100}%, rgba(240, 240, 240, 0) ${times.start / this.videoDuration * 100}%`\n          }\n          colors += `, #655dc2 ${times.start / this.videoDuration * 100}%, #655dc2 ${times.end / this.videoDuration * 100}%`\n          counter += 1\n        }\n        colors += `, rgba(240, 240, 240, 0) ${this.timings?.[counter - 1]?.end / this.videoDuration * 100}%, rgba(240, 240, 240, 0) 100%`\n        \n        this.dispatchEvent(new UpdateSeekableStyleEvent({ bubbles: true, composed: true, detail: { style: { backgroundImage: `linear-gradient(to right${colors})` }}}));\n      }\n      \n    }\n    \n    this.dispatchEvent(new VideoPauseEvent({ bubbles: true, composed: true }));\n\n    addActiveSegments();\n\n    let seekRatio = (event.clientX - this.seekableRect!.left) / this.seekableRect!.width;\n    const index = this.currentlyGrabbed!.index\n    const type = this.currentlyGrabbed!.type\n    let time = this.timings;\n    let seek = this.videoDuration * seekRatio\n  \n    if ((type === 'start') && (seek > ((index !== 0) ? (time[index - 1].end + difference + 0.2) : 0)) && seek < time[index].end - difference) {\n      this.dispatchEvent(new VideoSeekEvent({ bubbles: true, composed: true, detail: { seekTime: seek } }));\n\n      time[index]['start'] = seek;\n      this.dispatchEvent(new UpdateTimingsEvent({ bubbles: true, composed: true, detail: { timings: time } }))\n      \n      const grabberStart = this.shadowRoot?.getElementById(`grabberStart${index}`);\n      if (grabberStart) {\n        grabberStart.style.left = `${seekRatio * 100}%`;\n      }\n    } else if ((type === 'end')  && (seek > time[index].start + difference) && (seek < (index !== (this.timings.length - 1) ? time[index].start - difference - 0.2 : this.videoDuration))) {\n      this.dispatchEvent(new VideoSeekEvent({ bubbles: true, composed: true, detail: { seekTime: seek } }));\n\n      time[index]['end'] = seek;\n      this.dispatchEvent(new UpdateTimingsEvent({ bubbles: true, composed: true, detail: { timings: time } }));\n      \n      const grabberEnd = this.shadowRoot?.getElementById(`grabberEnd${index}`);\n      if (grabberEnd) {\n        grabberEnd.style.left = `${seekRatio * 100}%`;\n      }\n    }\n    \n    const progressLeft = `${seekRatio * 100}%`;\n    const progressWidth = '0%';\n    this.dispatchEvent(new UpdateProgressEvent({ bubbles: true, composed: true, detail: { left: progressLeft, width: progressWidth }}));\n  }\n\n  private removePointerMoveEventListener = () => {\n    window.removeEventListener('pointermove', this.handleMouseMoveWhenGrabbed)\n  }\n  \n  private removeMouseMoveEventListener = () => {\n    window.removeEventListener('mousemove', this.handleMouseMoveWhenGrabbed)\n  }\n\n  private handleGrabberMouseDown(index: number, type: string) {\n    return () => {\n      this.dispatchEvent(new UpdateCurrentlyGrabbedEvent({ bubbles: true, composed: true, detail: { index, type }}));\n      window.addEventListener('mousemove', this.handleMouseMoveWhenGrabbed);\n      window.addEventListener('mouseup', this.removeMouseMoveEventListener);\n    }\n  }\n\n  private handleGrabberPointerDown(index: number, type: string) {\n    return () => {\n      this.dispatchEvent(new UpdateCurrentlyGrabbedEvent({ bubbles: true, composed: true, detail: { index, type }}));\n      window.addEventListener('pointermove', this.handleMouseMoveWhenGrabbed)\n      window.addEventListener('pointerup', this.removePointerMoveEventListener)\n    }\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'playback-grabbers': PlaybackGrabbers;\n  }\n}\n"]}