{"version":3,"file":"playback-grabbers.js","sourceRoot":"","sources":["../../../src/components/playback/playback-grabbers.ts"],"names":[],"mappings":"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","sourcesContent":["import { LitElement, html } from 'lit';\nimport { customElement, state } from 'lit/decorators.js';\nimport { RangeTimings } from '../../types';\n// Events\nimport UpdateTimingsEvent from '../../events/update-timings';\nimport UpdateProgressEvent from '../../events/update-progress';\nimport { playbackGrabbersStyle } from '../../styles/playback-grabbers';\nimport '../../icons/icon-grabber';\nimport UpdatePlayerContextEvent from '../../events/update-player-context';\nimport { consume } from '@lit/context';\nimport { initialPlayerContext, playerContext } from '../../contexts/player-context';\nimport { GrabbersContext, PlayerContext, SeekableContext } from '../../@types/contexts';\nimport { initialSeekableContext, seekableContext } from '../../contexts/seekable-context';\nimport UpdateSeekableContextEvent from '../../events/update-seekable-context';\nimport { grabbersContext, initialGrabbersContext } from '../../contexts/grabbers-context';\nimport UpdateGrabbersContextEvent from '../../events/update-grabbers-context';\n\n@customElement('playback-grabbers')\nexport class PlaybackGrabbers extends LitElement {\n  static override styles = playbackGrabbersStyle;\n\n  @state()\n  timings: Array<RangeTimings> = [];\n\n  @consume({ context: playerContext, subscribe: true })\n  @state()\n  private playerCtx: PlayerContext = initialPlayerContext;\n\n  @consume({ context: seekableContext, subscribe: true })\n  @state()\n  private seekableCtx: SeekableContext = initialSeekableContext;\n\n  @consume({ context: grabbersContext, subscribe: true })\n  @state()\n  private grabbersCtx: GrabbersContext = initialGrabbersContext;\n\n  override render() {\n    const duration = this.playerCtx.duration;\n\n    return html`\n      <div id=\"grabbers\">\n        ${(this.grabbersCtx.visible && this.timings.length > 0) && this.timings.map((timing, i) => html`\n          <div id='grabberStart${i}' class='grabber' style=\"left: ${timing.start / duration * 100}%\"\n            @mousedown=\"${this.handleGrabberMouseDown(i, 'start')}\"\n            @pointerdown=\"${this.handleGrabberPointerDown(i, 'start')}\"\n          >\n            <icon-grabber></icon-grabber>\n          </div>\n          <div id='grabberEnd${i}' class='grabber' style=\"left: ${timing.end / duration * 100}%\"\n            @mousedown=\"${this.handleGrabberMouseDown(i, 'end')}\"\n            @pointerdown=\"${this.handleGrabberPointerDown(i, 'end')}\"\n          >\n            <icon-grabber></icon-grabber>\n          </div>\n        `)}\n      </div>\n    `;\n  }\n\n  private handleMouseMoveWhenGrabbed = (event: MouseEvent) => {\n    const duration = this.playerCtx.duration;\n    const seekableRect = this.seekableCtx.rect;\n    const currentlyGrabbed = this.grabbersCtx.currentlyGrabbed;\n    const difference = 0.2;\n\n    const addActiveSegments = () => {\n      let colors = ''\n      let counter = 0;\n\n      if (this.timings.length > 0) {\n        colors += `, rgba(240, 240, 240, 0) 0%, rgba(240, 240, 240, 0) ${this.timings?.[0].start / duration * 100}%`\n        for (let times of this.timings) {\n          if (counter > 0) {\n            colors += `, rgba(240, 240, 240, 0) ${this.timings[counter].end / duration * 100}%, rgba(240, 240, 240, 0) ${times.start / duration * 100}%`\n          }\n          colors += `, #655dc2 ${times.start / duration * 100}%, #655dc2 ${times.end / duration * 100}%`\n          counter += 1\n        }\n        colors += `, rgba(240, 240, 240, 0) ${this.timings?.[counter - 1]?.end / duration * 100}%, rgba(240, 240, 240, 0) 100%`\n        \n        this.dispatchEvent(new UpdateSeekableContextEvent({ style: { backgroundImage: `linear-gradient(to right${colors})` }}));\n      }\n    }\n\n    this.dispatchEvent(new UpdatePlayerContextEvent({ playing: false }));\n\n    addActiveSegments();\n\n    let seekRatio = (event.clientX - seekableRect!.left) / seekableRect!.width;\n    const index = currentlyGrabbed!.index\n    const type = currentlyGrabbed!.type\n    let time = this.timings;\n    let seek = duration * seekRatio\n  \n    if ((type === 'start') && (seek > ((index !== 0) ? (time[index - 1].end + difference + 0.2) : 0)) && seek < time[index].end - difference) {\n      \n      this.dispatchEvent(new UpdatePlayerContextEvent({ seek }));\n\n      time[index]['start'] = seek;\n      this.dispatchEvent(new UpdateTimingsEvent({ bubbles: true, composed: true, detail: { timings: time } }))\n      \n      const grabberStart = this.shadowRoot?.getElementById(`grabberStart${index}`);\n      if (grabberStart) {\n        grabberStart.style.left = `${seekRatio * 100}%`;\n      }\n    } else if ((type === 'end')  && (seek > time[index].start + difference) && (seek < (index !== (this.timings.length - 1) ? time[index].start - difference - 0.2 : duration))) {\n      this.dispatchEvent(new UpdatePlayerContextEvent({ seek }));\n\n      time[index]['end'] = seek;\n      this.dispatchEvent(new UpdateTimingsEvent({ bubbles: true, composed: true, detail: { timings: time } }));\n      \n      const grabberEnd = this.shadowRoot?.getElementById(`grabberEnd${index}`);\n      if (grabberEnd) {\n        grabberEnd.style.left = `${seekRatio * 100}%`;\n      }\n    }\n    \n    const progressLeft = `${seekRatio * 100}%`;\n    const progressWidth = '0%';\n    this.dispatchEvent(new UpdateProgressEvent({ bubbles: true, composed: true, detail: { left: progressLeft, width: progressWidth }}));\n  }\n\n  private removePointerMoveEventListener = () => {\n    window.removeEventListener('pointermove', this.handleMouseMoveWhenGrabbed)\n  }\n  \n  private removeMouseMoveEventListener = () => {\n    window.removeEventListener('mousemove', this.handleMouseMoveWhenGrabbed)\n  }\n\n  private handleGrabberMouseDown(index: number, type: string) {\n    return () => {\n      this.dispatchEvent(new UpdateGrabbersContextEvent({ currentlyGrabbed: { index, type } }));\n      window.addEventListener('mousemove', this.handleMouseMoveWhenGrabbed);\n      window.addEventListener('mouseup', this.removeMouseMoveEventListener);\n    }\n  }\n\n  private handleGrabberPointerDown(index: number, type: string) {\n    return () => {\n      this.dispatchEvent(new UpdateGrabbersContextEvent({ currentlyGrabbed: { index, type } }));\n      window.addEventListener('pointermove', this.handleMouseMoveWhenGrabbed)\n      window.addEventListener('pointerup', this.removePointerMoveEventListener)\n    }\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'playback-grabbers': PlaybackGrabbers;\n  }\n}\n"]}